openapi: 3.0.3
info:
  title: Supabase Backend API
  description: API para gerenciamento de usuarios e controle de caixa pessoal
  version: 1.0.0
  contact:
    name: Supabase Backend
    url: https://supabase.com
servers:
  - url: https://hlcjecnmvqjabammbdly.supabase.co/functions/v1
    description: Production server

paths:
  /auth/me:
    get:
      tags: [Auth]
      summary: Obter dados do usuario logado
      description: Retorna os dados de autenticacao do Supabase Auth e o perfil completo da tabela users
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Dados do usuario logado
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthMeResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /auth/login:
    post:
      tags: [Auth]
      summary: Login do usuario
      description: Realiza login com email e senha, retornando tokens de acesso e dados do usuario
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/AuthLoginRequest"
      responses:
        "200":
          description: Login realizado com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthLoginResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /cashflow/categories:
    get:
      tags: [Cashflow]
      summary: Listar categorias
      description: Retorna todas as categorias do usuario logado. Cada usuario so pode ver suas proprias categorias.
      security:
        - BearerAuth: []
      responses:
        "200":
          description: Lista de categorias do usuario
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoriesResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      tags: [Cashflow]
      summary: Criar categoria
      description: Cria uma nova categoria para receitas ou despesas. A categoria sera associada ao usuario logado.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CategoryInput"
      responses:
        "200":
          description: Categoria criada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CategoryResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          $ref: "#/components/responses/BadRequest"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /cashflow/transactions:
    get:
      tags: [Cashflow]
      summary: Listar transacoes
      description: Retorna transacoes do usuario com filtros opcionais
      security:
        - BearerAuth: []
      parameters:
        - name: start_date
          in: query
          description: Data de inicio (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          description: Data de fim (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: type
          in: query
          description: Tipo de transacao
          schema:
            type: string
            enum: [income, expense]
        - name: limit
          in: query
          description: Limite de resultados
          schema:
            type: integer
            default: 50
        - name: offset
          in: query
          description: Offset para paginacao
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: Lista de transacoes
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionsResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"
    post:
      tags: [Cashflow]
      summary: Criar transacao
      description: Cria uma nova transacao (receita ou despesa). Se category_id for fornecido, deve ser uma categoria do proprio usuario.
      security:
        - BearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransactionInput"
      responses:
        "200":
          description: Transacao criada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          description: Dados invalidos ou categoria nao pertence ao usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Categoria nao encontrada ou nao pertence ao usuario
        "500":
          $ref: "#/components/responses/InternalServerError"

  /cashflow/transactions/{id}:
    put:
      tags: [Cashflow]
      summary: Atualizar transacao
      description: Atualiza uma transacao existente. Se category_id for fornecido, deve ser uma categoria do proprio usuario.
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID da transacao
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/TransactionUpdateInput"
      responses:
        "200":
          description: Transacao atualizada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TransactionResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "400":
          description: Dados invalidos ou categoria nao pertence ao usuario
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
                    example: Categoria nao encontrada ou nao pertence ao usuario
        "404":
          description: Transacao nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"
    delete:
      tags: [Cashflow]
      summary: Deletar transacao
      description: Remove uma transacao
      security:
        - BearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          description: ID da transacao
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Transacao deletada com sucesso
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DeleteResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "404":
          description: Transacao nao encontrada
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          $ref: "#/components/responses/InternalServerError"

  /cashflow/summary:
    get:
      tags: [Cashflow]
      summary: Resumo financeiro
      description: Retorna resumo financeiro com total de receitas, despesas e saldo
      security:
        - BearerAuth: []
      parameters:
        - name: start_date
          in: query
          description: Data de inicio (YYYY-MM-DD)
          schema:
            type: string
            format: date
        - name: end_date
          in: query
          description: Data de fim (YYYY-MM-DD)
          schema:
            type: string
            format: date
      responses:
        "200":
          description: Resumo financeiro
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/SummaryResponse"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "500":
          $ref: "#/components/responses/InternalServerError"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token do Supabase Auth

  schemas:
    AuthLoginRequest:
      type: object
      properties:
        email:
          type: string
          format: email
          description: Email do usuario
        password:
          type: string
          description: Senha do usuario
      required:
        - email
        - password

    AuthLoginResponse:
      type: object
      properties:
        token_type:
          type: string
          description: Tipo do token
        access_token:
          type: string
          description: Token de acesso JWT
        refresh_token:
          type: string
          description: Token de refresh
        expires_in:
          type: integer
          description: Tempo de expiracao em segundos
        user:
          $ref: "#/components/schemas/AuthUser"
        profile:
          $ref: "#/components/schemas/UserProfile"

    AuthUser:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID unico do usuario
        email:
          type: string
          format: email
          description: Email do usuario
        phone:
          type: string
          nullable: true
          description: Telefone do usuario
        app_metadata:
          type: object
          additionalProperties: true
          description: Metadados da aplicacao
        user_metadata:
          type: object
          additionalProperties: true
          description: Metadados do usuario
        role:
          type: string
          nullable: true
          description: Role do usuario
        created_at:
          type: string
          format: date-time
          description: Data de criacao
        updated_at:
          type: string
          format: date-time
          description: Data da ultima atualizacao

    AuthMeResponse:
      type: object
      properties:
        user:
          $ref: "#/components/schemas/AuthUser"
        profile:
          $ref: "#/components/schemas/UserProfile"

    UserProfile:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID unico do usuario
        email:
          type: string
          format: email
          description: Email do usuario
        full_name:
          type: string
          description: Nome completo
        username:
          type: string
          description: Nome de usuario unico
        avatar_url:
          type: string
          format: uri
          description: URL do avatar
        bio:
          type: string
          description: Biografia do usuario
        phone:
          type: string
          description: Numero de telefone
        date_of_birth:
          type: string
          format: date
          description: Data de nascimento
        location:
          type: string
          description: Localizacao
        website:
          type: string
          format: uri
          description: Website pessoal
        is_staff:
          type: boolean
          description: Se o usuario tem privilegios de staff
        is_verified:
          type: boolean
          description: Se o email foi verificado
        is_active:
          type: boolean
          description: Se a conta esta ativa
        last_login:
          type: string
          format: date-time
          description: Ultimo login
        preferences:
          type: object
          description: Preferencias do usuario em formato JSON
        created_at:
          type: string
          format: date-time
          description: Data de criacao
        updated_at:
          type: string
          format: date-time
          description: Data da ultima atualizacao
      required:
        - id
        - email
        - full_name

    Category:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID unico da categoria
        name:
          type: string
          description: Nome da categoria
        type:
          type: string
          enum: [income, expense]
          description: Tipo da categoria
        color:
          type: string
          description: Cor da categoria
        icon:
          type: string
          description: Icone da categoria
        user_id:
          type: string
          format: uuid
          description: ID do usuario proprietario (cada categoria pertence a um usuario especifico)
        created_at:
          type: string
          format: date-time
          description: Data de criacao
        updated_at:
          type: string
          format: date-time
          description: Data da ultima atualizacao
      required:
        - id
        - name
        - type
        - user_id

    CategoryInput:
      type: object
      properties:
        name:
          type: string
          description: Nome da categoria
        type:
          type: string
          enum: [income, expense]
          description: Tipo da categoria
        color:
          type: string
          description: Cor da categoria
          default: "#3B82F6"
        icon:
          type: string
          description: Icone da categoria
          default: "💰"
      required:
        - name
        - type

    CategoryResponse:
      type: object
      properties:
        category:
          $ref: "#/components/schemas/Category"

    CategoriesResponse:
      type: object
      properties:
        categories:
          type: array
          items:
            $ref: "#/components/schemas/Category"

    Transaction:
      type: object
      properties:
        id:
          type: string
          format: uuid
          description: ID unico da transacao
        user_id:
          type: string
          format: uuid
          description: ID do usuario proprietario
        category_id:
          type: string
          format: uuid
          nullable: true
          description: ID da categoria
        type:
          type: string
          enum: [income, expense]
          description: Tipo da transacao
        amount:
          type: number
          format: decimal
          description: Valor da transacao
        description:
          type: string
          description: Descricao da transacao
        date:
          type: string
          format: date
          description: Data da transacao
        tags:
          type: array
          items:
            type: string
          description: Tags da transacao
        notes:
          type: string
          nullable: true
          description: Notas adicionais
        created_at:
          type: string
          format: date-time
          description: Data de criacao
        updated_at:
          type: string
          format: date-time
          description: Data da ultima atualizacao
        category:
          $ref: "#/components/schemas/Category"
      required:
        - id
        - user_id
        - type
        - amount
        - description

    TransactionInput:
      type: object
      properties:
        type:
          type: string
          enum: [income, expense]
          description: Tipo da transacao
        amount:
          type: number
          format: decimal
          description: Valor da transacao
        description:
          type: string
          description: Descricao da transacao
        date:
          type: string
          format: date
          description: Data da transacao
        category_id:
          type: string
          format: uuid
          nullable: true
          description: ID da categoria (opcional, deve ser uma categoria do proprio usuario)
        tags:
          type: array
          items:
            type: string
          description: Tags da transacao
        notes:
          type: string
          description: Notas adicionais
      required:
        - type
        - amount
        - description

    TransactionUpdateInput:
      type: object
      properties:
        type:
          type: string
          enum: [income, expense]
          description: Tipo da transacao
        amount:
          type: number
          format: decimal
          description: Valor da transacao
        description:
          type: string
          description: Descricao da transacao
        date:
          type: string
          format: date
          description: Data da transacao
        category_id:
          type: string
          format: uuid
          nullable: true
          description: ID da categoria (opcional, deve ser uma categoria do proprio usuario)
        tags:
          type: array
          items:
            type: string
          description: Tags da transacao
        notes:
          type: string
          description: Notas adicionais

    TransactionResponse:
      type: object
      properties:
        transaction:
          $ref: "#/components/schemas/Transaction"

    TransactionsResponse:
      type: object
      properties:
        transactions:
          type: array
          items:
            $ref: "#/components/schemas/Transaction"

    SummaryResponse:
      type: object
      properties:
        summary:
          type: object
          properties:
            totalIncome:
              type: number
              format: decimal
              description: Total de receitas
            totalExpenses:
              type: number
              format: decimal
              description: Total de despesas
            balance:
              type: number
              format: decimal
              description: Saldo

    DeleteResponse:
      type: object
      properties:
        message:
          type: string
          description: Mensagem de confirmacao

    ErrorResponse:
      type: object
      properties:
        error:
          type: string

  responses:
    Unauthorized:
      description: Token de autenticacao invalido ou ausente
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Unauthorized

    BadRequest:
      description: Requisicao invalida
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Invalid request data

    InternalServerError:
      description: Erro interno do servidor
      content:
        application/json:
          schema:
            type: object
            properties:
              error:
                type: string
                example: Internal server error

tags:
  - name: Auth
    description: Operacoes de autenticacao (login, dados do usuario logado)
  - name: Cashflow
    description: Sistema de controle de caixa pessoal (receitas, despesas, categorias). Cada usuario tem isolamento completo de seus dados.